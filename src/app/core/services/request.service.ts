import { Injectable } from '@angular/core';
import { Observable, of, BehaviorSubject, throwError } from 'rxjs';
import { ServiceRequest, RequestStep, RequestStatus, PaymentDetails, NegotiationHistory, PriceUpdate } from '../../shared/interfaces/request.interface';
@Injectable({
  providedIn: 'root'
})
export class RequestDataService {
  private currentRequest = new BehaviorSubject<Partial<ServiceRequest>>({});
  private negotiationHistory: NegotiationHistory[] = [];

  readonly steps: RequestStep[] = [
    { id: 1, title: 'ููุน ุงูุฎุฏูุฉ', subtitle: 'ุงุฎุชุฑ ุงูุฎุฏูุฉ ุงููุทููุจุฉ', icon: 'tools', completed: false },
    { id: 2, title: 'ุงูุชูุงุตูู', subtitle: 'ุงุถู ูุตู ุงููุดููุฉ ูุงูุตูุฑ', icon: 'image', completed: false },
    { id: 3, title: 'ุงููููุน ูุงูููุช', subtitle: 'ุญุฏุฏ ุงููููุน ูููุนุฏ ุงูุฎุฏูุฉ', icon: 'map-marker', completed: false },
    { id: 4, title: 'ุงูุฏูุน', subtitle: 'ุงุฎุชุฑ ุทุฑููุฉ ุงูุฏูุน ุงูููุงุณุจุฉ', icon: 'credit-card', completed: false }
  ];

  private readonly mockRequests: ServiceRequest[] = [
    {
      id: 1,
      category: 'electrician',
      service: 'ุชุตููุญ ุชูููู',
      description: 'ุงูุชูููู ูู ุบุฑูุฉ ุงูููู ูุง ูุนูู ุจุดูู ุฌูุฏ. ูุง ูุจุฑุฏ ุงูููุงุก ููุง ููุจุบู ูููุงู ุตูุช ุบุฑูุจ ูุตุฏุฑ ููู ุนูุฏ ุงูุชุดุบูู. ุฃุญุชุงุฌ ูููู ููุญุต ุงููุดููุฉ ูุฅุตูุงุญูุง.',
      location: {
        address: 'ุงููุนุงุฏูุ ุงููุงูุฑุฉ',
        coordinates: [30.0444, 31.2357]
      },
      scheduledDate: '2024-11-14',
      scheduledTime: '14:00',
      images: ['/api/placeholder/200/200', '/api/placeholder/200/200'],
      estimatedCost: 250,
      paymentMethod: 'cash',
      status: 'pending',
      createdAt: '2024-11-13T10:00:00',
      customerId: 1
    },
    {
      id: 2,
      category: 'plumber',
      service: 'ุตูุงูุฉ ุนุงูุฉ',
      description: 'ููุงู ุชุณุฑูุจ ููุงู ุจุทูุก ุชุญุช ุญูุถ ุงููุทุจุฎ. ูุจุฏู ุฃู ุงูุฃูุจูุจ ุชุงูู ููุญุชุงุฌ ูุงุณุชุจุฏุงู. ูุญุชุงุฌ ุณุจุงู ูู ุฃุณุฑุน ููุช ูุฅุตูุงุญ ุงููุดููุฉ ูุจู ุฃู ุชุชูุงูู.',
      location: {
        address: 'ูุฏููุฉ ูุตุฑุ ุงููุงูุฑุฉ',
        coordinates: [30.0511, 31.2497]
      },
      scheduledDate: '2024-11-14',
      scheduledTime: '10:00',
      images: ['/api/placeholder/200/200'],
      estimatedCost: 180,
      paymentMethod: 'cash',
      status: 'accepted',
      createdAt: '2024-11-13T14:30:00',
      customerId: 2,
      workerId: 3
    },
    {
      id: 3,
      category: 'electrician',
      service: 'ุชุตููุญ ุฃุฌูุฒุฉ',
      description: 'ุงูุบุณุงูุฉ ูุง ุชุนูู. ุนูุฏ ุชุดุบูููุงุ ูุง ูุญุฏุซ ุดูุก ุนูู ุงูุฅุทูุงู. ุฑุจูุง ุชููู ูุดููุฉ ููุฑุจุงุฆูุฉ. ุฃุญุชุงุฌ ููุฑุจุงุฆู ูุชุดุฎูุต ุงููุดููุฉ ูุฅุตูุงุญูุง ุฅุฐุง ุฃูููุ ุฃู ูุตูุญุฉ ุจุดุฃู ุงุณุชุจุฏุงููุง ุฅุฐุง ูุฒู ุงูุฃูุฑ.',
      location: {
        address: 'ุงููููุฏุณููุ ุงูุฌูุฒุฉ',
        coordinates: [30.0611, 31.2083]
      },
      scheduledDate: '2024-11-15',
      scheduledTime: '13:00',
      images: ['/api/placeholder/200/200', '/api/placeholder/200/200'],
      estimatedCost: 200,
      paymentMethod: 'cash',
      status: 'inProgress',
      createdAt: '2024-11-13T16:00:00',
      customerId: 1,
      workerId: 2
    },
    {
      id: 4,
      category: 'plumber',
      service: 'ุทูุงุฑุฆ',
      description: 'ููุฌุฏ ุงูุณุฏุงุฏ ุดุฏูุฏ ูู ุงูุญูุงู ููุง ูููู ุงุณุชุฎุฏุงูู ุนูู ุงูุฅุทูุงู. ุญุงูููุง ุงุณุชุฎุฏุงู ุงูููุจุณ ููู ุฏูู ุฌุฏูู. ูุญุชุงุฌ ุณุจุงู ุทูุงุฑุฆ ูููุฏูู ูู ุฃุณุฑุน ููุช ูููู!',
      location: {
        address: 'ุดุจุฑุงุ ุงููุงูุฑุฉ',
        coordinates: [30.1283, 31.2497]
      },
      scheduledDate: '2024-11-14',
      scheduledTime: '09:00',
      images: [],
      estimatedCost: 300,
      paymentMethod: 'cash',
      status: 'completed',
      createdAt: '2024-11-14T07:30:00',
      customerId: 3,
      workerId: 1
    },
    {
      id: 5,
      category: 'electrician',
      service: 'ุตูุงูุฉ ุนุงูุฉ',
      description: 'ููุงู ุนุฏุฉ ูุดุงูู ููุฑุจุงุฆูุฉ ุตุบูุฑุฉ ูู ุงูููุฒู. ุจุนุถ ุงูููุงุจุณ ูุง ุชุนููุ ูููุงู ุถูุก ูููุถ ูู ุงูุญูุงู. ูุญุชุงุฌ ููุฑุจุงุฆู ูุฅุฌุฑุงุก ูุญุต ุดุงูู ูุฅุตูุงุญ ุฃู ูุดุงูู.',
      location: {
        address: 'ุงูููุทูุ ุงููุงูุฑุฉ',
        coordinates: [30.0283, 31.3157]
      },
      scheduledDate: '2024-11-16',
      scheduledTime: '15:00',
      images: ['/api/placeholder/200/200'],
      estimatedCost: 150,
      paymentMethod: 'card',
      status: 'draft',
      createdAt: '2024-11-14T09:00:00',
      customerId: 4
    },
    {
      id: 6,
      category: 'plumber',
      service: 'ุตูุงูุฉ ุนุงูุฉ',
      description: 'ููุงู ูุดููุฉ ูู ุงูุตูุงุจูุฑ ูู ุงูุญูุงูุงุช. ุงูููุงู ูุง ุชุชุฏูู ุจุดูู ุฌูุฏ ููุจุฏู ุฃู ููุงู ุชุฑุงูู ูู ุงูุฃูุงุจูุจ. ูุญุชุงุฌ ุณุจุงู ูุชูุธูู ููุญุต ูุธุงู ุงูุณุจุงูุฉ.',
      location: {
        address: 'ูุตุฑ ุงูุฌุฏูุฏุฉุ ุงููุงูุฑุฉ',
        coordinates: [30.0883, 31.3197]
      },
      scheduledDate: '2024-11-15',
      scheduledTime: '11:00',
      images: [],
      estimatedCost: 120,
      paymentMethod: 'cash',
      status: 'pending',
      createdAt: '2024-11-14T10:30:00',
      customerId: 5
    },
    {
      id: 7,
      category: 'electrician',
      service: 'ุชุตููุญ ุชูููู',
      description: 'ุงูุชูููู ูู ุงูุตุงูุฉ ุชููู ุนู ุงูุนูู ูุฌุฃุฉ. ูุงู ูุนูู ุจุดูู ุฌูุฏ ูููู ุงูุขู ูุง ูุนูู ุนูู ุงูุฅุทูุงู. ูุญุชุงุฌ ููุฑุจุงุฆู ููุนุฑูุฉ ูุง ุฅุฐุง ูุงู ูููู ุฅุตูุงุญู ุฃู ููุฒู ุงุณุชุจุฏุงูู.',
      location: {
        address: 'ุงูุฏููุ ุงูุฌูุฒุฉ',
        coordinates: [30.0539, 31.2103]
      },
      scheduledDate: '2024-11-15',
      scheduledTime: '16:00',
      images: ['/api/placeholder/200/200'],
      estimatedCost: 220,
      paymentMethod: 'card',
      status: 'accepted',
      createdAt: '2024-11-14T12:00:00',
      customerId: 6,
      workerId: 2
    },
    {
      id: 8,
      category: 'plumber',
      service: 'ุทูุงุฑุฆ',
      description: 'ููุงู ุชุณุฑุจ ูุจูุฑ ููููุงู ูู ุงูููุฒู! ูุจุฏู ุฃู ุฃุญุฏ ุงูุฃูุงุจูุจ ุงูุฑุฆูุณูุฉ ุงููุฌุฑ. ูุญุชุงุฌ ุณุจุงู ูู ุญุงูุฉ ุทูุงุฑุฆ ููุฑูุง ูุฅููุงู ุงูุชุณุฑุจ ูุฅุตูุงุญ ุงููุดููุฉ ูุจู ุฃู ูุชุถุฑุฑ ุงูููุฒู ุจุฃูููู.',
      location: {
        address: 'ูุฏููุฉ ุงูุนุจูุฑุ ุงููุงูุฑุฉ',
        coordinates: [30.1811, 31.6083]
      },
      scheduledDate: '2024-11-14',
      scheduledTime: '20:00',
      images: ['/api/placeholder/200/200', '/api/placeholder/200/200', '/api/placeholder/200/200'],
      estimatedCost: 400,
      paymentMethod: 'cash',
      status: 'inProgress',
      createdAt: '2024-11-14T19:30:00',
      customerId: 7,
      workerId: 3
    },
    {
      id: 9,
      category: 'electrician',
      service: 'ุชุตููุญ ุฃุฌูุฒุฉ',
      description: 'ุงููุฑู ุงูููุฑุจุงุฆู ูุง ูุณุฎู ุจุดูู ุตุญูุญ. ูุจุฏุฃ ุงูุชุณุฎูู ููููู ูุง ูุตู ุฃุจุฏูุง ุฅูู ุฏุฑุฌุฉ ุงูุญุฑุงุฑุฉ ุงููุทููุจุฉ. ุฃุญุชุงุฌ ููุฑุจุงุฆู ููุชุญูู ูู ุงููุดููุฉ ูุฅุตูุงุญูุง.',
      location: {
        address: '6 ุฃูุชูุจุฑุ ุงูุฌูุฒุฉ',
        coordinates: [29.9511, 31.0083]
      },
      scheduledDate: '2024-11-16',
      scheduledTime: '12:00',
      images: ['/api/placeholder/200/200'],
      estimatedCost: 180,
      paymentMethod: 'cash',
      status: 'draft',
      createdAt: '2024-11-14T16:00:00',
      customerId: 8
    },
    {
      id: 10,
      category: 'plumber',
      service: 'ุตูุงูุฉ ุนุงูุฉ',
      description: 'ููุฏ ุฅุฌุฑุงุก ูุญุต ูุตูุงูุฉ ุนุงูุฉ ููุธุงู ุงูุณุจุงูุฉ ูู ููุฒููุง. ูู ุชูู ููุงู ุฃู ูุดุงูู ูุจูุฑุฉุ ููููุง ูุฑูุฏ ุงูุชุฃูุฏ ูู ุฃู ูู ุดูุก ูุนูู ุจุดูู ุณููู ูููุน ุฃู ูุดููุงุช ูุณุชูุจููุฉ.',
      location: {
        address: 'ุงูุฑุญุงุจุ ุงููุงูุฑุฉ',
        coordinates: [30.0611, 31.4917]
      },
      scheduledDate: '2024-11-17',
      scheduledTime: '10:00',
      images: [],
      estimatedCost: 100,
      paymentMethod: 'card',
      status: 'pending',
      createdAt: '2024-11-14T18:00:00',
      customerId: 9
    }
  ];

  readonly categories = [
    {
      id: 'electrician',
      name: 'ููุฑุจุงุฆู',
      icon: 'โก',
      services: [
        { id: 'general', name: 'ุตูุงูุฉ ุนุงูุฉ', basePrice: 150 },
        { id: 'ac', name: 'ุชุตููุญ ุชูููู', basePrice: 200 },
        { id: 'appliances', name: 'ุชุตููุญ ุฃุฌูุฒุฉ', basePrice: 180 }
      ]
    },
    {
      id: 'plumber',
      name: 'ุณุจุงู',
      icon: '๐ง',
      services: [
        { id: 'general', name: 'ุตูุงูุฉ ุนุงูุฉ', basePrice: 120 },
        { id: 'emergency', name: 'ุทูุงุฑุฆ', basePrice: 250 }
      ]
    }
  ];

  readonly statusConfig: Record<RequestStatus, { label: string; color: string; icon: string }> = {
    draft: { label: 'ูุณูุฏุฉ', color: 'gray', icon: 'draft' },
    pending: { label: 'ููุฏ ุงูุงูุชุธุงุฑ', color: 'yellow', icon: 'clock' },
    accepted: { label: 'ููุจูู', color: 'blue', icon: 'check' },
    inProgress: { label: 'ุฌุงุฑู ุงูุชูููุฐ', color: 'blue', icon: 'spinner' },
    completed: { label: 'ููุชูู', color: 'green', icon: 'check-circle' },
    cancelled: { label: 'ููุบู', color: 'red', icon: 'times-circle' }
  };

  readonly paymentMethods = [
    { id: 'cash' as const, name: 'ููุฏู', icon: 'money-bill' },
    { id: 'card' as const, name: 'ุจุทุงูุฉ ุงุฆุชูุงู', icon: 'credit-card' }
  ];

  constructor() { }

  // Request Management
  getCurrentRequest(): Observable<Partial<ServiceRequest>> {
    return this.currentRequest.asObservable();
  }

  updateCurrentRequest(request: Partial<ServiceRequest>): void {
    this.currentRequest.next({
      ...this.currentRequest.value,
      ...request
    });
  }

  getRequest(id: number): Observable<ServiceRequest> {
    const request = this.mockRequests.find(r => r.id === id);
    return request ? of(request) : of();
  }

  getRequests(status?: RequestStatus): Observable<ServiceRequest[]> {
    let filteredRequests = this.mockRequests;
    if (status) {
      filteredRequests = this.mockRequests.filter(r => r.status === status);
    }
    return of(filteredRequests);
  }

  createRequest(request: ServiceRequest): Observable<ServiceRequest> {
    const newRequest = {
      ...request,
      id: this.mockRequests.length + 1,
      createdAt: new Date().toISOString(),
      status: 'pending' as RequestStatus
    };
    return of(newRequest);
  }

  updateRequestStatus(id: number, status: RequestStatus): Observable<void> {
    const request = this.mockRequests.find(r => r.id === id);
    if (request) {
      request.status = status;
    }
    return of();
  }
  
  updateRequestPrice(requestId: number, update: PriceUpdate): Observable<void> {
    const request = this.mockRequests.find(r => r.id === requestId);
    if (!request || typeof request.estimatedCost !== 'number') {
      return throwError(() => new Error('Request not found or invalid price'));
    }
  
    const percentageChange = Number((
      ((update.price - request.estimatedCost) / request.estimatedCost) * 100
    ).toFixed(1));
  
    // Validate price change is within ยฑ15%
    if (Math.abs(percentageChange) > 15) {
      return throwError(() => new Error('Price change exceeds allowed limit of ยฑ15%'));
    }
  
    // Add to negotiation history
    this.negotiationHistory.push({
      id: this.negotiationHistory.length + 1,
      requestId,
      price: update.price,
      message: update.message,
      type: 'customer',
      timestamp: new Date().toISOString(),
      percentageChange
    });
  
    // Update the request's estimated cost
    request.estimatedCost = update.price;
  
    return of(void 0);
  }

  getNegotiationHistory(requestId: number): Observable<NegotiationHistory[]> {
    return of(this.negotiationHistory
      .filter(n => n.requestId === requestId)
      .sort((a, b) => new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime())
    );
  }

  validatePriceChange(originalPrice: number, newPrice: number): boolean {
    const percentageChange = ((newPrice - originalPrice) / originalPrice) * 100;
    return Math.abs(percentageChange) <= 15;
  }

  calculatePriceRange(originalPrice: number): { min: number; max: number } {
    return {
      min: Math.floor(originalPrice * 0.85),
      max: Math.ceil(originalPrice * 1.15)
    };
  }

  // Utility Methods
  calculateEstimatedCost(category: string, service: string): number {
    const categoryData = this.categories.find(c => c.id === category);
    const serviceData = categoryData?.services.find(s => s.id === service);
    const basePrice = serviceData?.basePrice || 0;
    return Math.round(basePrice + (Math.random() * 50));
  }

  getAvailableTimeSlots(date: string): string[] {
    return [
      '09:00', '10:00', '11:00', '12:00', '13:00',
      '14:00', '15:00', '16:00', '17:00', '18:00'
    ];
  }

  validateStep(step: number, data: Partial<ServiceRequest>): boolean {
    const validations = {
      1: () => Boolean(data.category && data.service),
      2: () => Boolean(data.description!.length >= 20),
      3: () => Boolean(data.location && data.scheduledDate && data.scheduledTime),
      4: () => Boolean(data.paymentMethod)
    };
    return validations[step as keyof typeof validations]?.() || false;
  }

  getStatusDetails(status: RequestStatus) {
    return this.statusConfig[status];
  }

  processPayment(payment: PaymentDetails): Observable<boolean> {
    return of(true);
  }

  getServicesByCategory(categoryId: string) {
    return this.categories.find(c => c.id === categoryId)?.services || [];
  }

  calculateVAT(amount: number): number {
    return amount * 0.14;
  }

  getServiceFee(): number {
    return 10;
  }

  getDiscount(): number {
    return 15;
  }

  calculateTotalCost(base: number, vat: number, fee: number, discount: number): number {
    return base + vat + fee - discount;
  }
}